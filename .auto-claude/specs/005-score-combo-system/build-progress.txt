# Score & Combo System - Build Progress

## Status: Planning Complete
Last Updated: 2025-12-30

---

## Implementation Plan Summary

**Total Estimated Hours:** 12
**Phases:** 7
**Subtasks:** 16

### Phase 1: Discovery & Assessment
- [x] 1.1 Document existing systems (COMPLETE - see analysis below)

### Phase 2: Combo Timer Bar UI
- [ ] 2.1 Add combo timer bar to HUD
- [ ] 2.2 Connect timer bar to ComboSystem

### Phase 3: Multi-Kill Bonus System
- [ ] 3.1 Track kills per slash update cycle
- [ ] 3.2 Add multi-kill bonus calculation
- [ ] 3.3 Add multi-kill visual feedback

### Phase 4: Combo Milestone Effects
- [ ] 4.1 Create milestone detection in ComboSystem
- [ ] 4.2 Create ComboEffectsManager
- [ ] 4.3 Integrate ComboEffectsManager with GameplayScene

### Phase 5: Score Display Enhancements
- [ ] 5.1 Add floating score text on kill
- [ ] 5.2 Add score pop effect in HUD

### Phase 6: Edge Cases & Polish
- [ ] 6.1 Handle pause state for combo timer
- [ ] 6.2 Reset combo on scene transitions
- [ ] 6.3 Handle simultaneous kills correctly

### Phase 7: Testing & QA
- [ ] 7.1 Manual gameplay testing
- [ ] 7.2 Performance verification
- [ ] 7.3 Final polish and tuning

---

## Existing Systems Analysis

### Already Implemented ✓
1. **ComboSystem** (src/systems/ComboSystem.ts)
   - Combo count tracking with increment()/reset()
   - Multiplier calculation: 1 + (combo * 0.1)
   - Timeout logic: 2 seconds
   - EventBus 'combo-updated' events
   - getRemainingTime() method
   - Max combo tracking

2. **SlashSystem** (src/systems/SlashSystem.ts)
   - Score calculation with combo multiplier
   - Per-monster-type scoring (zombie=10, vampire=15, ghost=20)
   - 'score-updated', 'monster-sliced' events
   - Basic hit effect animations

3. **HUD** (src/ui/HUD.ts)
   - Score text display
   - Combo count/multiplier display
   - Pulse animation on combo update
   - Event listeners setup

4. **ParticleSystem** (src/systems/ParticleSystem.ts)
   - Multiple particle types (SPARKLE, FIRE, ICE, etc.)
   - Object pooling for performance
   - emit() for one-shot effects

5. **Constants** (src/config/constants.ts)
   - COMBO_TIMEOUT = 2.0 seconds
   - COMBO_MULTIPLIER_RATE = 0.1
   - COMBO_MILESTONES = [5, 10, 15, 20, 25, 30, 40, 50, 75, 100]
   - MONSTER_BASE_POINTS per type

### Needs Implementation ✗
1. **Combo Timer Bar** - Visual countdown in HUD
2. **Multi-Kill Tracking** - Per-update-cycle kill counting
3. **Multi-Kill Bonus** - Bonus multiplier for 2+ kills per swipe
4. **Milestone Detection** - Event emission at 5x, 10x, 15x
5. **Milestone Effects** - Particle bursts, screen flashes, text
6. **Floating Score Text** - "+X points" at kill position
7. **Score Pop Animation** - HUD score pulse on gain

---

## Key Files to Modify

| File | Changes Required |
|------|-----------------|
| src/systems/ComboSystem.ts | Add milestone detection, emit combo-milestone events |
| src/systems/SlashSystem.ts | Multi-kill tracking, floating score text |
| src/ui/HUD.ts | Timer bar, score pop effect |
| src/config/constants.ts | MULTI_KILL_BONUS constants |
| src/scenes/GameplayScene.ts | Integrate ComboEffectsManager |

## New Files to Create

| File | Purpose |
|------|---------|
| src/managers/ComboEffectsManager.ts | Handle milestone visual effects |

---

## Session Notes

### Session 1 (2025-12-30)
- Read spec.md and analyzed requirements
- Explored existing codebase structure
- Created detailed implementation plan with 7 phases, 16 subtasks
- Documented existing systems analysis
- Most scoring/combo infrastructure already exists
- Main work: visual feedback (timer bar, milestones, multi-kills)

### Session 2 - Subtask 1.1 Discovery (2025-12-30)
**Completed detailed review of all core systems:**

#### ComboSystem.ts Analysis (116 lines)
- **increment()**: Increments combo, resets timer to COMBO_TIMEOUT*1000ms, updates multiplier, tracks max combo, emits 'combo-updated'
- **reset()**: Sets combo/timer/multiplier to initial values, emits event
- **update(time, delta)**: Decrements comboTimer by delta, calls reset() when expired
- **updateMultiplier()**: Formula: `1 + (combo * COMBO_MULTIPLIER_RATE)` = 1 + (combo * 0.1)
- **getRemainingTime()**: Returns `Math.max(0, comboTimer / 1000)` in seconds
- **GAP**: No milestone detection or 'combo-milestone' event emission

#### SlashSystem.ts Analysis (547 lines)
- **checkMonsterCollisions()**: Calls monster.slice(), increments combo via comboSystem.increment()
- **Score calculation**: `basePoints * multiplier` where multiplier includes combo + frenzy + upgrades + critical
- **createHitEffect()**: Creates flash circle + tween fade, shows "CRITICAL!" floating text for crits
- **Events emitted**: 'monster-sliced' (includes comboCount), 'score-updated' (includes delta)
- **GAP**: Processes monsters one-by-one in loop - no multi-kill tracking per update cycle

#### HUD.ts Analysis (539 lines)
- **updateCombo()**: Shows combo count as "Xx" with multiplier label, applies pulse tween (scale 1.2, yoyo)
- **Positioning**: Combo displayed at center-top (GAME_WIDTH/2, GAME_HEIGHT*0.2)
- **Score**: Top-left with label
- **Theme integration**: Uses DARK_GOTHIC_THEME for fonts, colors, animation settings
- **GAP**: No timer bar graphics, no score pop animation on large gains

#### ParticleSystem.ts Analysis (551 lines)
- **ParticleTypes available**: SOUL_WISP, GHOST_MIST, BLOOD_SPLATTER, FIRE, ICE, LIGHTNING, BUTTON_CLICK, WEAPON_TRAIL, SPARKLE
- **emit()**: Takes ParticleConfig {type, x, y, count, scale, speed, lifespan, alpha, tint, blendMode}
- **Object pooling**: Max 5 emitters per type, auto-cleanup after lifespan
- **Textures**: All created dynamically via canvas (radial gradients, shapes)
- **OPPORTUNITY**: Can easily add combo milestone effects using existing infrastructure

#### constants.ts Analysis (374 lines)
- **COMBO_TIMEOUT**: 2.0 seconds
- **COMBO_MULTIPLIER_RATE**: 0.1 (so 10 combo = 2.0x multiplier)
- **COMBO_MILESTONES**: [5, 10, 15, 20, 25, 30, 40, 50, 75, 100] - already defined!
- **MONSTER_BASE_POINTS**: zombie=10, vampire=15, ghost=20
- **MONSTER_SOULS**: zombie=5, vampire=8, ghost=10
- **GAP**: No MULTI_KILL_BONUS constants defined

#### Key Integration Points Identified
1. **GameplayScene** calls comboSystem.update(time, delta) every frame
2. **EventBus** is central event system - use for combo-milestone events
3. **Theme system** (DARK_GOTHIC_THEME) provides consistent styling
4. **Tween patterns** well-established for animations

#### Implementation Strategy Confirmed
- Phase 2: Add Graphics-based timer bar to HUD, update in update() method
- Phase 3: Track kills array in SlashSystem.update(), apply bonus after loop
- Phase 4: Check milestone array in ComboSystem.increment(), emit new event
- Phase 5: Create floating text in SlashSystem similar to CRITICAL! pattern
- Phase 6: Add isPaused check, reset calls in shutdown()
