# Score & Combo System - Build Progress

## Status: Planning Complete
Last Updated: 2025-12-30

---

## Implementation Plan Summary

**Total Estimated Hours:** 12
**Phases:** 7
**Subtasks:** 16

### Phase 1: Discovery & Assessment
- [x] 1.1 Document existing systems (COMPLETE - see analysis below)

### Phase 2: Combo Timer Bar UI
- [ ] 2.1 Add combo timer bar to HUD
- [ ] 2.2 Connect timer bar to ComboSystem

### Phase 3: Multi-Kill Bonus System
- [ ] 3.1 Track kills per slash update cycle
- [ ] 3.2 Add multi-kill bonus calculation
- [ ] 3.3 Add multi-kill visual feedback

### Phase 4: Combo Milestone Effects
- [ ] 4.1 Create milestone detection in ComboSystem
- [ ] 4.2 Create ComboEffectsManager
- [ ] 4.3 Integrate ComboEffectsManager with GameplayScene

### Phase 5: Score Display Enhancements
- [ ] 5.1 Add floating score text on kill
- [ ] 5.2 Add score pop effect in HUD

### Phase 6: Edge Cases & Polish
- [ ] 6.1 Handle pause state for combo timer
- [ ] 6.2 Reset combo on scene transitions
- [ ] 6.3 Handle simultaneous kills correctly

### Phase 7: Testing & QA
- [ ] 7.1 Manual gameplay testing
- [ ] 7.2 Performance verification
- [ ] 7.3 Final polish and tuning

---

## Existing Systems Analysis

### Already Implemented ✓
1. **ComboSystem** (src/systems/ComboSystem.ts)
   - Combo count tracking with increment()/reset()
   - Multiplier calculation: 1 + (combo * 0.1)
   - Timeout logic: 2 seconds
   - EventBus 'combo-updated' events
   - getRemainingTime() method
   - Max combo tracking

2. **SlashSystem** (src/systems/SlashSystem.ts)
   - Score calculation with combo multiplier
   - Per-monster-type scoring (zombie=10, vampire=15, ghost=20)
   - 'score-updated', 'monster-sliced' events
   - Basic hit effect animations

3. **HUD** (src/ui/HUD.ts)
   - Score text display
   - Combo count/multiplier display
   - Pulse animation on combo update
   - Event listeners setup

4. **ParticleSystem** (src/systems/ParticleSystem.ts)
   - Multiple particle types (SPARKLE, FIRE, ICE, etc.)
   - Object pooling for performance
   - emit() for one-shot effects

5. **Constants** (src/config/constants.ts)
   - COMBO_TIMEOUT = 2.0 seconds
   - COMBO_MULTIPLIER_RATE = 0.1
   - COMBO_MILESTONES = [5, 10, 15, 20, 25, 30, 40, 50, 75, 100]
   - MONSTER_BASE_POINTS per type

### Needs Implementation ✗
1. **Combo Timer Bar** - Visual countdown in HUD
2. **Multi-Kill Tracking** - Per-update-cycle kill counting
3. **Multi-Kill Bonus** - Bonus multiplier for 2+ kills per swipe
4. **Milestone Detection** - Event emission at 5x, 10x, 15x
5. **Milestone Effects** - Particle bursts, screen flashes, text
6. **Floating Score Text** - "+X points" at kill position
7. **Score Pop Animation** - HUD score pulse on gain

---

## Key Files to Modify

| File | Changes Required |
|------|-----------------|
| src/systems/ComboSystem.ts | Add milestone detection, emit combo-milestone events |
| src/systems/SlashSystem.ts | Multi-kill tracking, floating score text |
| src/ui/HUD.ts | Timer bar, score pop effect |
| src/config/constants.ts | MULTI_KILL_BONUS constants |
| src/scenes/GameplayScene.ts | Integrate ComboEffectsManager |

## New Files to Create

| File | Purpose |
|------|---------|
| src/managers/ComboEffectsManager.ts | Handle milestone visual effects |

---

## Session Notes

### Session 1 (2025-12-30)
- Read spec.md and analyzed requirements
- Explored existing codebase structure
- Created detailed implementation plan with 7 phases, 16 subtasks
- Documented existing systems analysis
- Most scoring/combo infrastructure already exists
- Main work: visual feedback (timer bar, milestones, multi-kills)

### Session 2 - Subtask 1.1 Discovery (2025-12-30)
**Completed detailed review of all core systems:**

#### ComboSystem.ts Analysis (116 lines)
- **increment()**: Increments combo, resets timer to COMBO_TIMEOUT*1000ms, updates multiplier, tracks max combo, emits 'combo-updated'
- **reset()**: Sets combo/timer/multiplier to initial values, emits event
- **update(time, delta)**: Decrements comboTimer by delta, calls reset() when expired
- **updateMultiplier()**: Formula: `1 + (combo * COMBO_MULTIPLIER_RATE)` = 1 + (combo * 0.1)
- **getRemainingTime()**: Returns `Math.max(0, comboTimer / 1000)` in seconds
- **GAP**: No milestone detection or 'combo-milestone' event emission

#### SlashSystem.ts Analysis (547 lines)
- **checkMonsterCollisions()**: Calls monster.slice(), increments combo via comboSystem.increment()
- **Score calculation**: `basePoints * multiplier` where multiplier includes combo + frenzy + upgrades + critical
- **createHitEffect()**: Creates flash circle + tween fade, shows "CRITICAL!" floating text for crits
- **Events emitted**: 'monster-sliced' (includes comboCount), 'score-updated' (includes delta)
- **GAP**: Processes monsters one-by-one in loop - no multi-kill tracking per update cycle

#### HUD.ts Analysis (539 lines)
- **updateCombo()**: Shows combo count as "Xx" with multiplier label, applies pulse tween (scale 1.2, yoyo)
- **Positioning**: Combo displayed at center-top (GAME_WIDTH/2, GAME_HEIGHT*0.2)
- **Score**: Top-left with label
- **Theme integration**: Uses DARK_GOTHIC_THEME for fonts, colors, animation settings
- **GAP**: No timer bar graphics, no score pop animation on large gains

#### ParticleSystem.ts Analysis (551 lines)
- **ParticleTypes available**: SOUL_WISP, GHOST_MIST, BLOOD_SPLATTER, FIRE, ICE, LIGHTNING, BUTTON_CLICK, WEAPON_TRAIL, SPARKLE
- **emit()**: Takes ParticleConfig {type, x, y, count, scale, speed, lifespan, alpha, tint, blendMode}
- **Object pooling**: Max 5 emitters per type, auto-cleanup after lifespan
- **Textures**: All created dynamically via canvas (radial gradients, shapes)
- **OPPORTUNITY**: Can easily add combo milestone effects using existing infrastructure

#### constants.ts Analysis (374 lines)
- **COMBO_TIMEOUT**: 2.0 seconds
- **COMBO_MULTIPLIER_RATE**: 0.1 (so 10 combo = 2.0x multiplier)
- **COMBO_MILESTONES**: [5, 10, 15, 20, 25, 30, 40, 50, 75, 100] - already defined!
- **MONSTER_BASE_POINTS**: zombie=10, vampire=15, ghost=20
- **MONSTER_SOULS**: zombie=5, vampire=8, ghost=10
- **GAP**: No MULTI_KILL_BONUS constants defined

#### Key Integration Points Identified
1. **GameplayScene** calls comboSystem.update(time, delta) every frame
2. **EventBus** is central event system - use for combo-milestone events
3. **Theme system** (DARK_GOTHIC_THEME) provides consistent styling
4. **Tween patterns** well-established for animations

#### Implementation Strategy Confirmed
- Phase 2: Add Graphics-based timer bar to HUD, update in update() method
- Phase 3: Track kills array in SlashSystem.update(), apply bonus after loop
- Phase 4: Check milestone array in ComboSystem.increment(), emit new event
- Phase 5: Create floating text in SlashSystem similar to CRITICAL! pattern
- Phase 6: Add isPaused check, reset calls in shutdown()

---

## QA Testing Session - Subtask 7.1
**Date:** 2025-12-30
**Tester:** Auto-Claude

### Code Review Verification ✓

All implementation files reviewed and verified:

#### 1. ComboSystem.ts ✓
- [x] Combo increment on monster kill
- [x] Combo timer (2.0 seconds timeout)
- [x] Multiplier calculation: 1 + (combo * 0.1)
- [x] Milestone detection at 5, 10, 15, 20, 25 combos
- [x] 'combo-milestone' event emission with milestone + multiplier data
- [x] Milestone tracking to prevent re-triggering (reachedMilestones Set)
- [x] Pause state support (setPaused/getIsPaused)
- [x] Full reset for new games (fullReset method)
- [x] Max combo tracking

#### 2. SlashSystem.ts ✓
- [x] Per-monster-type scoring (zombie=10, vampire=15, ghost=20)
- [x] Combo multiplier applied to each kill
- [x] Multi-kill tracking per update cycle (killsThisCycle counter)
- [x] Multi-kill bonus calculation (2 kills=1.5x, 3 kills=2.0x, 4+=2.5x)
- [x] Simultaneous kills handled correctly (each kill increments combo for next)
- [x] Floating score text (+X points) at kill position
- [x] Color-coded scores by value (100+=purple, 50+=orange, 25+=yellow)
- [x] DOUBLE/TRIPLE/MEGA/ULTRA KILL visual feedback
- [x] Screen flash for high kill counts (4+)
- [x] Particle effects for multi-kills

#### 3. HUD.ts ✓
- [x] Score display text
- [x] Combo count display (Xx format)
- [x] Combo multiplier label
- [x] Combo timer bar (visual countdown)
- [x] Timer bar color transition (warning -> danger as depletes)
- [x] Score pop animation on gains (4 tiers: 1.1x-1.4x based on points)
- [x] update() method connected to game loop
- [x] Proper cleanup in destroy()

#### 4. ComboEffectsManager.ts ✓
- [x] Milestone text animations ("COMBO x5!", "LEGENDARY!", etc.)
- [x] Screen flash effects (edge flash for 5-10x, full screen for 15x+)
- [x] Particle bursts at milestones (SPARKLE, FIRE, LIGHTNING)
- [x] Radial and corner particle patterns for higher milestones
- [x] Multiplier text display below milestone text
- [x] Escalating effects for higher milestones (20x, 25x+)
- [x] EventBus listener for 'combo-milestone' events
- [x] Proper cleanup and destroy methods

#### 5. GameplayScene.ts Integration ✓
- [x] ComboSystem update in game loop
- [x] HUD update connected to ComboSystem
- [x] ComboEffectsManager initialized and connected
- [x] ParticleSystem connected to SlashSystem and ComboEffectsManager
- [x] Combo reset on game over (preserves max combo)
- [x] Combo reset on level complete
- [x] Full reset on restart
- [x] Pause state properly pauses combo timer
- [x] Proper cleanup in shutdown()

#### 6. constants.ts ✓
- [x] COMBO_TIMEOUT = 2.0 seconds
- [x] COMBO_MULTIPLIER_RATE = 0.1
- [x] COMBO_MILESTONES = [5, 10, 15, 20, 25, 30, 40, 50, 75, 100]
- [x] MULTI_KILL_BONUS constants defined
- [x] getMultiKillBonus() helper function
- [x] MONSTER_BASE_POINTS per type
- [x] EVENTS.comboMilestone added

---

### Manual QA Test Checklist

**Gameplay Verification:**
- [ ] Score starts at 0 when game begins
- [ ] Each monster kill increases score
- [ ] Different monster types award different scores (zombie=10, vampire=15, ghost=20)
- [ ] Combo multiplier shows as "1x" initially
- [ ] Combo increments with rapid kills (within 2 seconds)
- [ ] Combo timer bar depletes smoothly when no kills
- [ ] Timer bar refills to full on each kill
- [ ] Timer bar changes color as it depletes (orange -> red)
- [ ] Combo resets to 1x when timer expires
- [ ] Floating score text appears at kill position
- [ ] Score text color changes based on value
- [ ] Score pop animation in HUD on point gain (scales with gain amount)

**Multi-Kill Verification:**
- [ ] DOUBLE KILL! (2 kills in one swipe) triggers feedback
- [ ] TRIPLE KILL! (3 kills) shows orange text
- [ ] MEGA KILL! (4 kills) shows orange-red text
- [ ] ULTRA KILL! (5+ kills) shows red text
- [ ] Multi-kill bonus score appears as "+X BONUS!"
- [ ] Particle effects at each kill position
- [ ] Screen flash for 4+ kills

**Milestone Verification:**
- [ ] 5x combo triggers "COMBO x5!" text + sparkle particles
- [ ] 10x combo triggers "COMBO x10!" + edge flash + fire particles
- [ ] 15x combo triggers "LEGENDARY!" + full screen flash
- [ ] 20x combo triggers "UNSTOPPABLE!" + lightning particles
- [ ] 25x combo triggers "GODLIKE!" + enhanced effects
- [ ] Multiplier text shows below milestone text
- [ ] Effects don't re-trigger for same milestone in same combo chain

**Edge Case Verification:**
- [ ] Killing 2+ monsters in same frame counts both toward combo
- [ ] Each kill in same frame gets incrementally higher multiplier
- [ ] Pausing game freezes combo timer
- [ ] Resuming game continues timer correctly
- [ ] Combo resets on game over
- [ ] Combo resets between levels/scenes
- [ ] Very high combos (20x+) don't break UI
- [ ] Villager slice resets combo

**UI Verification:**
- [ ] Score text is readable (contrast, size)
- [ ] Combo text is readable
- [ ] Timer bar is clearly visible
- [ ] UI doesn't cover important gameplay areas
- [ ] Text updates immediately on kill
- [ ] Timer animation is smooth
- [ ] Milestone effects don't permanently obscure gameplay

**Performance Verification:**
- [ ] No frame drops during combo gameplay
- [ ] Particle effects don't cause lag
- [ ] UI updates don't impact game performance
- [ ] Tweens are properly cleaned up

---

### Code Quality Verification ✓
- [x] No console.log debugging statements (only appropriate console.log in GameplayScene.create)
- [x] Error handling in place (null checks, optional chaining)
- [x] Proper cleanup in destroy() methods
- [x] TypeScript types correctly defined
- [x] Follows existing code patterns
- [x] Uses EventBus for loose coupling
- [x] Uses theme constants for consistent styling

---

### Issues Found
None - all code properly implemented and follows patterns.

### Recommendations for Manual Testing
1. Start game and kill monsters rapidly to build combo
2. Let combo timeout to verify reset
3. Slice multiple monsters in one swipe to trigger multi-kill
4. Build combo to 5x, 10x, 15x to verify milestone effects
5. Pause/unpause during active combo to verify timer freeze
6. Die and restart to verify reset behavior
7. Complete level to verify reset behavior

---

## Performance Verification - Subtask 7.2
**Date:** 2025-12-30
**Tester:** Auto-Claude

### Performance Code Analysis ✓

Comprehensive review of all combo system components for performance issues:

#### 1. ParticleSystem.ts - ✅ OPTIMIZED
**Memory Management:**
- [x] Object pooling with `maxEmittersPerType = 5` (prevents unbounded growth)
- [x] Auto-release emitters after lifespan via `scene.time.delayedCall`
- [x] Periodic cleanup of inactive emitters in `update()` method (~1s interval)
- [x] `destroy()` method properly cleans all emitters and clears Maps/Sets

**Performance Features:**
- Pool limit of 5 emitters per type prevents excessive particle rendering
- `cleanupInactiveEmitters()` keeps minimum 2 emitters per type when not in use
- Textures created once via canvas (not re-created per effect)

**Frame Drop Risk:** LOW - Well-designed pooling system

#### 2. ComboEffectsManager.ts - ✅ OPTIMIZED
**Memory Management:**
- [x] `activeTexts` array tracks all floating text objects
- [x] Text objects destroyed in tween `onComplete` callbacks
- [x] `cleanup()` method destroys all active texts + clears graphics
- [x] `destroy()` removes EventBus listener + calls cleanup + destroys graphics
- [x] Screen flash graphics cleared after animations

**Performance Features:**
- Milestone particle counts are reasonable (20-75 particles)
- Screen flash uses simple fillRect (not expensive)
- Tweens auto-complete and destroy targets

**Frame Drop Risk:** LOW - Proper cleanup at all exit points

#### 3. SlashSystem.ts - ✅ OPTIMIZED
**Memory Management:**
- [x] All floating score texts destroyed in tween `onComplete` callbacks
- [x] Multi-kill text objects destroyed in `onComplete`
- [x] Screen flash graphics destroyed in `onComplete`
- [x] `killPositionsThisCycle` array reset at start of each update cycle
- [x] `hitFlashGraphics` properly destroyed in `destroy()` method

**Performance Features:**
- SCORE_TEXT_COLORS uses simple threshold comparison (O(1))
- Font size scaling capped at reasonable values (18-36px)
- Multi-kill particle count scales linearly: `8 + killCount * 2`

**Frame Drop Risk:** LOW - All temporary objects cleaned up

#### 4. HUD.ts - ✅ OPTIMIZED
**Memory Management:**
- [x] `scorePopTween` reference stored and stopped before creating new tween
- [x] `destroy()` stops active tweens and destroys all elements
- [x] Event listeners properly removed in `destroy()`
- [x] Timer bar uses simple rectangle width changes (not graphics redraw)

**Performance Features:**
- `blendColors()` uses bit operations (efficient)
- Timer bar updates only when visible
- No expensive operations in `update()` loop

**Frame Drop Risk:** LOW - Minimal per-frame operations

#### 5. GameplayScene.ts Integration - ✅ OPTIMIZED
**Memory Management:**
- [x] All systems properly destroyed in `shutdown()`
- [x] Event listeners removed in `shutdown()`
- [x] `comboSystem.fullReset()` clears milestone Set on shutdown
- [x] `comboEffectsManager.destroy()` called on shutdown
- [x] `particleSystem.destroy()` called on shutdown

**Performance Features:**
- HUD.update() receives ComboSystem reference (no event spam)
- Systems updated in efficient order in game loop
- Boss/campaign mode updates only when active

**Frame Drop Risk:** LOW - Clean lifecycle management

---

### Memory Leak Prevention Checklist ✓

| Category | Status | Notes |
|----------|--------|-------|
| ParticleSystem object pooling | ✅ | Max 5 emitters per type |
| Text objects destroyed | ✅ | All in tween onComplete |
| Graphics objects cleaned | ✅ | clear() + destroy() called |
| Event listeners removed | ✅ | In all destroy() methods |
| Milestone Set cleared | ✅ | fullReset() clears reachedMilestones |
| Timer references nullified | ✅ | scorePopTween = null after complete |

---

### Frame Drop Prevention Checklist ✓

| Concern | Mitigation | Status |
|---------|------------|--------|
| Too many particles | Pool limit (5 per type) | ✅ |
| Large particle bursts | Reasonable counts (20-75) | ✅ |
| Simultaneous tweens | Tweens auto-managed by Phaser | ✅ |
| Screen flash rendering | Simple fillRect operations | ✅ |
| Text rendering | Cached fonts, no canvas re-creation | ✅ |
| UI update frequency | Only when visible/needed | ✅ |

---

### Extended Session Memory Considerations ✓

**What happens during 10+ minute sessions:**
1. **Particles:** Pool maintains max 5 emitters per type, unused cleaned after ~1s
2. **Floating Texts:** Each destroyed within 800-1500ms via tween onComplete
3. **Milestone Texts:** Destroyed within 1500ms via tween onComplete
4. **Screen Flashes:** Cleared within 200-400ms via tween onComplete
5. **Combo Milestones Set:** Never exceeds 10 entries (milestone values: 5,10,15,20,25,30,40,50,75,100)

**Potential Long-Session Issues:** NONE FOUND
- All temporary game objects are properly destroyed
- No unbounded arrays or collections
- No closure memory leaks detected
- Event listeners properly scoped and removed

---

### Performance Verification Summary

| Component | Memory Safe | Frame Safe | Extended Session Safe |
|-----------|-------------|------------|----------------------|
| ParticleSystem | ✅ | ✅ | ✅ |
| ComboEffectsManager | ✅ | ✅ | ✅ |
| SlashSystem | ✅ | ✅ | ✅ |
| HUD | ✅ | ✅ | ✅ |
| GameplayScene | ✅ | ✅ | ✅ |

**OVERALL STATUS: ✅ PASSED**

No performance issues or memory leaks detected in the combo system implementation.
All components properly manage resources and clean up after themselves.

---

### Browser DevTools Verification Recommendations

For manual runtime verification:
1. Open Chrome DevTools → Performance tab
2. Record during 5+ minute gameplay session with high combo activity
3. Check:
   - [ ] FPS stays at 60 (no drops below 55)
   - [ ] Memory heap doesn't continuously grow
   - [ ] No "GC pause" spikes > 16ms

4. Open Chrome DevTools → Memory tab
5. Take heap snapshot before and after 5 min session
6. Check:
   - [ ] No significant retained memory growth
   - [ ] No detached DOM elements
   - [ ] ParticleEmitter count stays bounded
